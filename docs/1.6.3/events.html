<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title>Using BarbelHisto events · BarbelHisto</title><meta name="viewport" content="width=device-width"/><meta name="generator" content="Docusaurus"/><meta name="description" content="&lt;p&gt;&lt;code&gt;BarbelHisto&lt;/code&gt; provides an event mechanism to extend the core functionality. Clients can implement event handler methods to handle the events. Amongst other uses these event handlers can drive the integration with external data sources. The event mechanism is based on &lt;a href=&quot;https://github.com/google/guava&quot;&gt;Google Guavas&lt;/a&gt; &lt;code&gt;EventBus&lt;/code&gt; implementation.&lt;/p&gt;
"/><meta name="docsearch:version" content="1.6.3"/><meta name="docsearch:language" content="en"/><meta property="og:title" content="Using BarbelHisto events · BarbelHisto"/><meta property="og:type" content="website"/><meta property="og:url" content="https://www.projectbarbel.org/index.html"/><meta property="og:description" content="&lt;p&gt;&lt;code&gt;BarbelHisto&lt;/code&gt; provides an event mechanism to extend the core functionality. Clients can implement event handler methods to handle the events. Amongst other uses these event handlers can drive the integration with external data sources. The event mechanism is based on &lt;a href=&quot;https://github.com/google/guava&quot;&gt;Google Guavas&lt;/a&gt; &lt;code&gt;EventBus&lt;/code&gt; implementation.&lt;/p&gt;
"/><meta property="og:image" content="https://www.projectbarbel.org/img/logo_blau_weiss_klein.png"/><meta name="twitter:card" content="summary"/><meta name="twitter:image" content="https://www.projectbarbel.org/img/logo_blau_weiss_klein.png"/><link rel="shortcut icon" href="/img/small_barbel.png"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css"/><script>
              (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
              (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
              m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
              })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

              ga('create', 'UA-135274031-1', 'auto');
              ga('send', 'pageview');
            </script><script type="text/javascript" src="https://buttons.github.io/buttons.js"></script><link rel="stylesheet" href="/css/prism.css"/><link rel="stylesheet" href="/css/main.css"/><script src="/js/codetabs.js"></script></head><body class="sideNavVisible separateOnPageNav"><div class="fixedHeaderContainer"><div class="headerWrapper wrapper"><header><a href="/"><img class="logo" src="/img/small_barbel.png" alt="BarbelHisto"/><h2 class="headerTitleWithLogo">BarbelHisto</h2></a><a href="/versions"><h3>1.6.3</h3></a><div class="navigationWrapper navigationSlider"><nav class="slidingNav"><ul class="nav-site nav-site-internal"><li class="siteNavGroupActive"><a href="/docs/1.6.3/getstarted" target="_self">Docs</a></li><li class=""><a href="/help" target="_self">Help</a></li></ul></nav></div></header></div></div><div class="navPusher"><div class="docMainWrapper wrapper"><div class="container docsNavContainer" id="docsNav"><nav class="toc"><div class="toggleNav"><section class="navWrapper wrapper"><div class="navBreadcrumb wrapper"><div class="navToggle" id="navToggler"><i></i></div><h2><i>›</i><span>Documentation</span></h2><div class="tocToggler" id="tocToggler"><i class="icon-toc"></i></div></div><div class="navGroups"><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">Documentation<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/docs/1.6.3/getstarted">Get started with POJOs</a></li><li class="navListItem"><a class="navItem" href="/docs/1.6.3/bitemporal">Mode BITEMPORAL</a></li><li class="navListItem"><a class="navItem" href="/docs/1.6.3/timeshift">Journey through time</a></li><li class="navListItem"><a class="navItem" href="/docs/1.6.3/indexing">Adding indexes</a></li><li class="navListItem navListItemActive"><a class="navItem" href="/docs/1.6.3/events">Using events</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">Persistence<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/docs/1.6.3/persistence">Persistence basics</a></li><li class="navListItem"><a class="navItem" href="/docs/1.6.3/diskpersistence">Disk persistence</a></li><li class="navListItem"><a class="navItem" href="/docs/1.6.3/mongo">Integrating MongoDB</a></li><li class="navListItem"><a class="navItem" href="/docs/1.6.3/performance">Performance setups</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">Tutorials<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/docs/1.6.3/mongotutorial">MongoDB tutorial</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">Project details<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/docs/1.6.3/about">About</a></li><li class="navListItem"><a class="navItem" href="/docs/1.6.3/license">License</a></li><li class="navListItem"><a class="navItem" href="/docs/1.6.3/download">Download</a></li><li class="navListItem"><a class="navItem" href="/docs/1.6.3/support">Getting Support</a></li><li class="navListItem"><a class="navItem" href="/docs/1.6.3/acknowledge">Acknowledgements</a></li><li class="navListItem"><a class="navItem" href="/docs/1.6.3/repo">Source Repository</a></li><li class="navListItem"><a class="navItem" href="/docs/1.6.3/releasenotes">Release Notes</a></li></ul></div></div></section></div><script>
            var coll = document.getElementsByClassName('collapsible');
            var checkActiveCategory = true;
            for (var i = 0; i < coll.length; i++) {
              var links = coll[i].nextElementSibling.getElementsByTagName('*');
              if (checkActiveCategory){
                for (var j = 0; j < links.length; j++) {
                  if (links[j].classList.contains('navListItemActive')){
                    coll[i].nextElementSibling.classList.toggle('hide');
                    coll[i].childNodes[1].classList.toggle('rotate');
                    checkActiveCategory = false;
                    break;
                  }
                }
              }

              coll[i].addEventListener('click', function() {
                var arrow = this.childNodes[1];
                arrow.classList.toggle('rotate');
                var content = this.nextElementSibling;
                content.classList.toggle('hide');
              });
            }

            document.addEventListener('DOMContentLoaded', function() {
              createToggler('#navToggler', '#docsNav', 'docsSliderActive');
              createToggler('#tocToggler', 'body', 'tocActive');

              const headings = document.querySelector('.toc-headings');
              headings && headings.addEventListener('click', function(event) {
                if (event.target.tagName === 'A') {
                  document.body.classList.remove('tocActive');
                }
              }, false);

              function createToggler(togglerSelector, targetSelector, className) {
                var toggler = document.querySelector(togglerSelector);
                var target = document.querySelector(targetSelector);

                if (!toggler) {
                  return;
                }

                toggler.onclick = function(event) {
                  event.preventDefault();

                  target.classList.toggle(className);
                };
              }
            });
        </script></nav></div><div class="container mainContainer"><div class="wrapper"><div class="post"><header class="postHeader"><h1 class="postHeaderTitle">Using BarbelHisto events</h1></header><article><div><span><p><code>BarbelHisto</code> provides an event mechanism to extend the core functionality. Clients can implement event handler methods to handle the events. Amongst other uses these event handlers can drive the integration with external data sources. The event mechanism is based on <a href="https://github.com/google/guava">Google Guavas</a> <code>EventBus</code> implementation.</p>
<p>Events are posted to synchronous and/or asynchronous <code>EventBus</code> instances. In case events are posted to synchronous and asynchronous event bus, they are refered to as posted 'both way'. Synchronous events are executed in the same thread issueing the event, which means that the handler methods listening to synchronous events execute synchronously. This can be usefull for many scenarios, like pre-fetching data in a lazy loading <code>BarbelHisto</code> instance. See <a href="persistence">the persistence tutorial</a> for details.</p>
<h2><a class="anchor" aria-hidden="true" id="event-types"></a><a href="#event-types" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Event types</h2>
<p>The following events are posted by <code>BarbelHisto</code>:</p>
<ol>
<li><code>EventType.BARBELINITIALIZED</code> when <code>BarbelHisto</code> instance is created, only once per <code>BarbelHisto</code> session, both way.</li>
<li><code>EventType.INITIALIZEJOURNAL</code> when journal is created, only once per document journal creation, both way</li>
<li><code>EventType.ACQUIRELOCK</code>, when <code>BarbelHisto</code> starts updating a document journal, synchronous post</li>
<li><code>EventType.REPLACEBITEMPORAL</code>, when versions are inactivated, maybe multiple times in a single update operation, both way</li>
<li><code>EventType.INSERTBITEMPORAL</code>, when new versions are inserted, one time per update operation, both way</li>
<li><code>EventType.UPDATEFINISHED</code>, when the update operation for journal was completed, once per save operation, both way</li>
<li><code>EventType.RELEASELOCK</code>, when <code>BarbelHisto</code> finishes the updating cycle, synchronous post</li>
<li>The <code>EventType.RETRIEVEDATA</code> event is posted each time when clients retrieve data from <code>BarbelHisto</code>.</li>
<li>The <code>EventType.ONLOADOPERATION</code> event is posted each time when clients load data into <code>BarbelHisto</code> using the <code>load</code> operation.</li>
<li>The <code>EventType.UNONLOADOPERATION</code> event is posted each time when clients unload data from <code>BarbelHisto</code> using the <code>unload</code> operation.</li>
</ol>
<p>Events 2-7 are posted in exactly that order in an update operation performed by the <code>save()</code> method of <code>BarbelHisto</code>.</p>
<h2><a class="anchor" aria-hidden="true" id="event-handler-methods"></a><a href="#event-handler-methods" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Event handler methods</h2>
<p>Listeners to these events are implemented as the following examples:</p>
<pre><code class="hljs css language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UpdateEventListeners</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Subscribe</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleInitialization</span><span class="token punctuation">(</span>BarbelInitializedEvent event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// ... handle event</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Subscribe</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleInserts</span><span class="token punctuation">(</span>InsertBitemporalEvent event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// ... handle event</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Subscribe</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleReplacements</span><span class="token punctuation">(</span>ReplaceBitemporalEvent event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// ... handle event</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">"unchecked"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LazyLoadingListener</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Subscribe</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleRetrieveData</span><span class="token punctuation">(</span>RetrieveDataEvent event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// ... handle event</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Subscribe</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleInitializeJournal</span><span class="token punctuation">(</span>InitializeJournalEvent event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// ... handle event</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Use the <code>@Subscribe</code> annotation to subscribe the handler method to the event declared as parameter. The event passed contains the <code>eventContext</code> that can be used to drive processing. It contains an instance of the <code>DocumentJournal</code> that was or will be updated and the like. Clients can use these context parameters to implement sophisticated event handling. The context data is always a copy of what originally happened, so clients cannot harm <code>BarbelHisto</code>s internal consistency.</p>
<h2><a class="anchor" aria-hidden="true" id="register-listeners"></a><a href="#register-listeners" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Register listeners</h2>
<p>To put listener classes in action clients register instances of the listener classes with <code>BarbelHistoBuilder</code>.</p>
<pre><code class="hljs css language-java">BarbelHisto<span class="token generics function"><span class="token punctuation">&lt;</span>DefaultDocument<span class="token punctuation">></span></span> core <span class="token operator">=</span> BarbelHistoBuilder<span class="token punctuation">.</span><span class="token function">barbel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">withMode</span><span class="token punctuation">(</span>BarbelMode<span class="token punctuation">.</span>BITEMPORAL<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">withSynchronousEventListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LazyLoadingListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>The above snippet shows a registration in the synchronous event bus. Registration with asynchronous bus works accordingly.</p>
<h2><a class="anchor" aria-hidden="true" id="error-handling"></a><a href="#error-handling" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Error handling</h2>
<p>By default handler methods <strong>fail silently</strong>. This is because subsequent handler methods should still be executed when a previous handler fails. In synchronous scenarios, however, it can be very useful to stop processing if an event handler fails. Clients stop processing by setting the event passed into the handler method to <code>HistoEvent.failed()</code>. As a consequence, <code>BarbelHisto</code> will rollback any changes made to the instance in the running update operation and return an <code>HistoEventFailedException</code> to the client. Here is an example pattern of using the described error handling.</p>
<pre><code class="hljs css language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">ShadowCollectionListeners</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Subscribe</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleInserts</span><span class="token punctuation">(</span>InsertBitemporalEvent event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// some processing that may fail and client wants to handle that situation</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            event<span class="token punctuation">.</span><span class="token function">failed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Subscribe</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleReplacements</span><span class="token punctuation">(</span>ReplaceBitemporalEvent event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// some processing that may fail and client wants to handle that situation</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            event<span class="token punctuation">.</span><span class="token function">failed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>When an exception is thrown during processing of these event handlers, the event is set to failed, and <code>BarbelHisto</code> will throw an exception right after leaving the event handler.</p>
</span></div></article></div><div class="docs-prevnext"><a class="docs-prev button" href="/docs/1.6.3/indexing"><span class="arrow-prev">← </span><span>Adding indexes</span></a><a class="docs-next button" href="/docs/1.6.3/persistence"><span>Persistence basics</span><span class="arrow-next"> →</span></a></div></div></div><nav class="onPageNav"><ul class="toc-headings"><li><a href="#event-types">Event types</a></li><li><a href="#event-handler-methods">Event handler methods</a></li><li><a href="#register-listeners">Register listeners</a></li><li><a href="#error-handling">Error handling</a></li></ul></nav></div><footer class="nav-footer" id="footer"><section class="sitemap"><a href="/" class="nav-home"><img src="/img/small_barbel.png" alt="BarbelHisto" width="66" height="58"/></a><div><h5>Docs</h5><a href="/docs/getstarted.html">Getting Started</a></div><div><h5>Community</h5><a href="https://github.com/projectbarbel/barbelhisto-core/issues">Report issue</a></div><div><h5>More</h5><a href="https://github.com/projectbarbel/barbelhisto-core">GitHub</a><a class="github-button" href="https://github.com/projectbarbel/barbelhisto-core" data-icon="octicon-star" data-count-href="/stargazers" data-show-count="true" data-count-aria-label="# stargazers on GitHub" aria-label="BarbelHisto">Star</a></div></section><section class="copyright">Copyright © 2019 Project Barbel</section></footer></div></body></html>