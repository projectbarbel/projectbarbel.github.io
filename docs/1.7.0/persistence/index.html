<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title>Persistence integration basics · BarbelHisto</title><meta name="viewport" content="width=device-width"/><meta name="generator" content="Docusaurus"/><meta name="description" content="&lt;p&gt;In &lt;code&gt;BarbelHisto&lt;/code&gt; there are three flavors of persistence, you can choose the CqEngine persistence options, persistence integration using events, or you choose a custom persistence.&lt;/p&gt;
"/><meta name="docsearch:version" content="1.7.0"/><meta name="docsearch:language" content="en"/><meta property="og:title" content="Persistence integration basics · BarbelHisto"/><meta property="og:type" content="website"/><meta property="og:url" content="https://www.projectbarbel.org/index.html"/><meta property="og:description" content="&lt;p&gt;In &lt;code&gt;BarbelHisto&lt;/code&gt; there are three flavors of persistence, you can choose the CqEngine persistence options, persistence integration using events, or you choose a custom persistence.&lt;/p&gt;
"/><meta property="og:image" content="https://www.projectbarbel.org/img/logo_blau_weiss_klein.png"/><meta name="twitter:card" content="summary"/><meta name="twitter:image" content="https://www.projectbarbel.org/img/logo_blau_weiss_klein.png"/><link rel="shortcut icon" href="/img/small_barbel.png"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css"/><script>
              (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
              (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
              m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
              })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

              ga('create', 'UA-135274031-1', 'auto');
              ga('send', 'pageview');
            </script><script type="text/javascript" src="https://buttons.github.io/buttons.js"></script><link rel="stylesheet" href="/css/prism.css"/><link rel="stylesheet" href="/css/main.css"/><script src="/js/codetabs.js"></script></head><body class="sideNavVisible separateOnPageNav"><div class="fixedHeaderContainer"><div class="headerWrapper wrapper"><header><a href="/"><img class="logo" src="/img/small_barbel.png" alt="BarbelHisto"/><h2 class="headerTitleWithLogo">BarbelHisto</h2></a><a href="/versions"><h3>1.7.0</h3></a><div class="navigationWrapper navigationSlider"><nav class="slidingNav"><ul class="nav-site nav-site-internal"><li class="siteNavGroupActive"><a href="/docs/1.7.0/getstarted" target="_self">Docs</a></li><li class=""><a href="/help" target="_self">Help</a></li></ul></nav></div></header></div></div><div class="navPusher"><div class="docMainWrapper wrapper"><div class="container docsNavContainer" id="docsNav"><nav class="toc"><div class="toggleNav"><section class="navWrapper wrapper"><div class="navBreadcrumb wrapper"><div class="navToggle" id="navToggler"><i></i></div><h2><i>›</i><span>Persistence</span></h2><div class="tocToggler" id="tocToggler"><i class="icon-toc"></i></div></div><div class="navGroups"><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">Documentation<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/docs/1.7.0/getstarted">Get started with POJOs</a></li><li class="navListItem"><a class="navItem" href="/docs/1.7.0/bitemporal">Mode BITEMPORAL</a></li><li class="navListItem"><a class="navItem" href="/docs/1.7.0/timeshift">Journey through time</a></li><li class="navListItem"><a class="navItem" href="/docs/1.7.0/indexing">Adding indexes</a></li><li class="navListItem"><a class="navItem" href="/docs/1.7.0/events">Using events</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">Persistence<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem navListItemActive"><a class="navItem" href="/docs/1.7.0/persistence">Persistence basics</a></li><li class="navListItem"><a class="navItem" href="/docs/1.7.0/diskpersistence">Disk persistence</a></li><li class="navListItem"><a class="navItem" href="/docs/1.7.0/mongo">Integrating MongoDB</a></li><li class="navListItem"><a class="navItem" href="/docs/1.7.0/performance">Performance setups</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">Tutorials<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/docs/1.7.0/mongotutorial">MongoDB tutorial</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">Example applications<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/docs/1.7.0/springboot">Spring Boot service helper</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">Project details<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/docs/1.7.0/about">About</a></li><li class="navListItem"><a class="navItem" href="/docs/1.7.0/license">License</a></li><li class="navListItem"><a class="navItem" href="/docs/1.7.0/download">Download</a></li><li class="navListItem"><a class="navItem" href="/docs/1.7.0/support">Getting Support</a></li><li class="navListItem"><a class="navItem" href="/docs/1.7.0/acknowledge">Acknowledgements</a></li><li class="navListItem"><a class="navItem" href="/docs/1.7.0/repo">Source Repository</a></li><li class="navListItem"><a class="navItem" href="/docs/1.7.0/releasenotes">Release Notes</a></li></ul></div></div></section></div><script>
            var coll = document.getElementsByClassName('collapsible');
            var checkActiveCategory = true;
            for (var i = 0; i < coll.length; i++) {
              var links = coll[i].nextElementSibling.getElementsByTagName('*');
              if (checkActiveCategory){
                for (var j = 0; j < links.length; j++) {
                  if (links[j].classList.contains('navListItemActive')){
                    coll[i].nextElementSibling.classList.toggle('hide');
                    coll[i].childNodes[1].classList.toggle('rotate');
                    checkActiveCategory = false;
                    break;
                  }
                }
              }

              coll[i].addEventListener('click', function() {
                var arrow = this.childNodes[1];
                arrow.classList.toggle('rotate');
                var content = this.nextElementSibling;
                content.classList.toggle('hide');
              });
            }

            document.addEventListener('DOMContentLoaded', function() {
              createToggler('#navToggler', '#docsNav', 'docsSliderActive');
              createToggler('#tocToggler', 'body', 'tocActive');

              const headings = document.querySelector('.toc-headings');
              headings && headings.addEventListener('click', function(event) {
                if (event.target.tagName === 'A') {
                  document.body.classList.remove('tocActive');
                }
              }, false);

              function createToggler(togglerSelector, targetSelector, className) {
                var toggler = document.querySelector(togglerSelector);
                var target = document.querySelector(targetSelector);

                if (!toggler) {
                  return;
                }

                toggler.onclick = function(event) {
                  event.preventDefault();

                  target.classList.toggle(className);
                };
              }
            });
        </script></nav></div><div class="container mainContainer"><div class="wrapper"><div class="post"><header class="postHeader"><h1 class="postHeaderTitle">Persistence integration basics</h1></header><article><div><span><p>In <code>BarbelHisto</code> there are three flavors of persistence, you can choose the CqEngine persistence options, persistence integration using events, or you choose a custom persistence.</p>
<h2><a class="anchor" aria-hidden="true" id="cqengine-built-in-persistence"></a><a href="#cqengine-built-in-persistence" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>CqEngine built-in persistence</h2>
<p><code>BarbelHisto</code> is based on <a href="https://github.com/npgall/cqengine">CqEngine collections</a>, so clients can use any persistence options currently available in CqEngine. The default persistence of <code>BarbelHisto</code> is <code>OnHeapPersistence</code>. To change that you add a custom backbone collection. If you want to add <code>DiskPersistence</code> you'd need to define the primary key attribute as described in the CqEngine documentation:</p>
<pre><code class="hljs css language-java"><span class="token keyword">final</span> <span class="token class-name">SimpleAttribute</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PrimitivePrivatePojo</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">></span></span> PRIMARY_KEY <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleAttribute</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PrimitivePrivatePojo</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token string">"versionId"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getValue</span><span class="token punctuation">(</span><span class="token class-name">PrimitivePrivatePojo</span> object<span class="token punctuation">,</span> <span class="token class-name">QueryOptions</span> queryOptions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Bitemporal</span><span class="token punctuation">)</span>object<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBitemporalStamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getVersionId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
<p>POJOs get passed as <code>Bitemporal</code> proxies, that's why you can cast them to <code>Bitemporal</code> to get access to the version id via the <code>BitemporalStamp</code>. In this example we use a standard POJO <code>PrimitivePrivatePojo</code> annotated with the <code>@DocumentId</code> and <code>@PersistenceConfig</code> annotation.</p>
<pre><code class="hljs css language-java"><span class="token annotation punctuation">@PersistenceConfig</span><span class="token punctuation">(</span>serializer<span class="token operator">=</span><span class="token class-name">BarbelPojoSerializer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> polymorphic<span class="token operator">=</span><span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PrimitivePrivatePojo</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@DocumentId</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> id<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> someBoolean<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">byte</span> somByte<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">short</span> someShort<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">char</span> someChar<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> someInt<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">float</span> someFloat<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">long</span> someLong<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">double</span> someDouble<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>The <code>@PersistenceConfig</code> annotation is mandatory for the disk persistence to function properly with CGLib proxies when using <code>BarbelMode.POJO</code>. In <code>BarbelMode.BITEMPORAL</code> this annotation is not required.</p>
<p>The field definition <code>PRIMARY_KEY</code> returns the version id as primary key for the persistence index. Now, create a persistent collection with <code>BarbelHisto</code> using the standard CqEngine API and <code>BarbelHistoBuilder</code>:</p>
<pre><code class="hljs css language-java"><span class="token class-name">BarbelHisto</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PrimitivePrivatePojo</span><span class="token punctuation">></span></span> core <span class="token operator">=</span> <span class="token class-name">BarbelHistoBuilder</span><span class="token punctuation">.</span><span class="token function">barbel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">.</span><span class="token function">withBackboneSupplier</span><span class="token punctuation">(</span>
                  <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentIndexedCollection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PrimitivePrivatePojo</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token class-name">DiskPersistence</span><span class="token punctuation">.</span>
                       <span class="token function">onPrimaryKeyInFile</span><span class="token punctuation">(</span>PRIMARY_KEY<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token string">"data.dat"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                  <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>See the <a href="https://github.com/npgall/cqengine">CqEngine documentation</a> on all the options you can choose.</p>
<h2><a class="anchor" aria-hidden="true" id="event-based-persistence"></a><a href="#event-based-persistence" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Event-based persistence</h2>
<p><code>BarbelHisto</code> provides a sophisticated event mechanism to synchronize the backbone version data with external data sources. Events are posted on initialization tasks and data updates. Clients can register listeners for events and connect external data sources through the listeners. This enables  synchronization with an external data source. In the following examples we describe what you need to achieve this kind of persistence integration.</p>
<h3><a class="anchor" aria-hidden="true" id="shadow-data-source"></a><a href="#shadow-data-source" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Shadow data source</h3>
<p>To connect the backbone and mirror the data into a custom external data source, clients create listener methods. The first method initializes the <code>shadow</code> data source:</p>
<pre><code class="hljs css language-java"><span class="token annotation punctuation">@Subscribe</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleInitialization</span><span class="token punctuation">(</span><span class="token class-name">BarbelInitializedEvent</span> event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// initialize connection to backend</span>
<span class="token punctuation">}</span>
</code></pre>
<p>All listener methods need to be annotated with <code>@Subscribe</code>. The following listener method listens to inserts and replacements of data in the <code>BarbelHisto</code> backbone:</p>
<pre><code class="hljs css language-java"><span class="token annotation punctuation">@Subscribe</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleUpdates</span><span class="token punctuation">(</span><span class="token class-name">UpdateFinishedEvent</span> event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Bitemporal</span><span class="token punctuation">></span></span> inserts <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Bitemporal</span><span class="token punctuation">></span></span><span class="token punctuation">)</span> event<span class="token punctuation">.</span><span class="token function">getEventContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">UpdateFinishedEvent</span><span class="token punctuation">.</span>NEWVERSIONS<span class="token punctuation">)</span><span class="token punctuation">;</span>
    inserts<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>v <span class="token operator">-></span> shadow<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">DefaultDocument</span><span class="token punctuation">)</span> v<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Inactivation</span><span class="token punctuation">></span></span> inactivations <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Inactivation</span><span class="token punctuation">></span></span><span class="token punctuation">)</span> event<span class="token punctuation">.</span><span class="token function">getEventContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">UpdateFinishedEvent</span><span class="token punctuation">.</span>INACTIVATIONS<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// perform inserts and replacements to data source</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Update handler method extract the data from the event context and drop that into (or remove them from) the <code>shadow</code> data source. Notice that each handler method is annotated with the <code>@Subscribe</code> annotation and then takes the specific event as parameter. For a complete list of events see <code>EventType</code>. Next, clients register their listeners, i.e. the classes containing listener methods, to their <code>BarbelHisto</code> instance like so:</p>
<pre><code class="hljs css language-java"><span class="token class-name">BarbelHisto</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DefaultDocument</span><span class="token punctuation">></span></span> barbel <span class="token operator">=</span> <span class="token class-name">BarbelHistoBuilder</span><span class="token punctuation">.</span><span class="token function">barbel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">withMode</span><span class="token punctuation">(</span><span class="token class-name">BarbelMode</span><span class="token punctuation">.</span>BITEMPORAL<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">withSynchronousEventListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ShadowCollectionListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>When you save objects to <code>BarbelHisto</code> the <code>shadow</code> data source will contain a complete copy of the backbone, since all changes are mirrored into the shadow data source.</p>
<blockquote>
<p>To improve performance on write operations considerably it's also possible to register the described <strong>update</strong> listeners with the <strong>asynchronous</strong> event bus. This would, however, also require some more sophisticated error handling to ensure data integrity.</p>
</blockquote>
<h3><a class="anchor" aria-hidden="true" id="lazy-loading-external-data"></a><a href="#lazy-loading-external-data" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Lazy loading external data</h3>
<p>The next step to complete integration of external data sources using events would be to lazy load data from these data sources that were shadowed in previous <code>BarbelHisto</code>sessions.
The following example listener method waits for the <code>RetrieveDataEvent</code> posted by <code>BarbelHisto</code> when clients request data:</p>
<pre><code class="hljs css language-java"><span class="token annotation punctuation">@Subscribe</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleRetrieveData</span><span class="token punctuation">(</span><span class="token class-name">RetrieveDataEvent</span> event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Query</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DefaultDocument</span><span class="token punctuation">></span></span> query <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Query</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DefaultDocument</span><span class="token punctuation">></span></span><span class="token punctuation">)</span> event<span class="token punctuation">.</span><span class="token function">getEventContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">RetrieveDataEvent</span><span class="token punctuation">.</span>QUERY<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">BarbelHisto</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DefaultDocument</span><span class="token punctuation">></span></span> histo <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">BarbelHisto</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DefaultDocument</span><span class="token punctuation">></span></span><span class="token punctuation">)</span> event<span class="token punctuation">.</span><span class="token function">getEventContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">RetrieveDataEvent</span><span class="token punctuation">.</span>BARBEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token class-name">String</span> documentId <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span><span class="token class-name">BarbelQueries</span><span class="token punctuation">.</span><span class="token function">returnIDForQuery</span><span class="token punctuation">(</span>query<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// draw data from backend data source by document id</span>
    <span class="token comment">// load that data to the backbone ...</span>
    histo<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>docs<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span>
</code></pre>
<p>The listener method looks into the <code>Query</code> posted by the client to get the document id value and then pre-fetches the version data for this document id into <code>BarbelHisto</code> using the <code>BarbelHisto.load</code> method. This is the most common way for pre-fetching: by document id.</p>
<p>We're almost done now. When you'd use lazy loading you need another listener for the cases where the client wants to save new versions for document id journals not previosly fetched into <code>BarbelHisto</code>. This listener must listen to the <code>InitializeJournalEvent</code> event. Here is the example:</p>
<pre><code class="hljs css language-java"><span class="token annotation punctuation">@Subscribe</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleInitializeJournal</span><span class="token punctuation">(</span><span class="token class-name">InitializeJournalEvent</span> event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">DocumentJournal</span> journal <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">DocumentJournal</span><span class="token punctuation">)</span>event<span class="token punctuation">.</span><span class="token function">getEventContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">DocumentJournal</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">BarbelHisto</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DefaultDocument</span><span class="token punctuation">></span></span> histo <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">BarbelHisto</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DefaultDocument</span><span class="token punctuation">></span></span><span class="token punctuation">)</span> event<span class="token punctuation">.</span><span class="token function">getEventContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">RetrieveDataEvent</span><span class="token punctuation">.</span>BARBEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> documentId <span class="token operator">=</span> journal<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// draw the data by document ID from the backend data source</span>
    <span class="token comment">// load the data into the backbone ...</span>
    histo<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>docs<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>This listener draws the document journal for the document id from the external source and loads the version data into the barbel histo instance <strong>before</strong> the new version will be saved.</p>
<p>With these listener methods implemented in the previous examples you will be able to lazy load and mirror back data from and to the external sources.</p>
<p>Last not least clients need to register the lazy loading listener:</p>
<pre><code class="hljs css language-java"><span class="token class-name">BarbelHisto</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DefaultDocument</span><span class="token punctuation">></span></span> core <span class="token operator">=</span> <span class="token class-name">BarbelHistoBuilder</span><span class="token punctuation">.</span>barbel<span class="token punctuation">.</span><span class="token function">withMode</span><span class="token punctuation">(</span><span class="token class-name">BarbelMode</span><span class="token punctuation">.</span>BITEMPORAL<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">withSynchronousEventListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LazyLoadingListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// query should be pre-fetched with data from the lazy loading listeners</span>
<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DefaultDocument</span><span class="token punctuation">></span></span> docs <span class="token operator">=</span> core<span class="token punctuation">.</span><span class="token function">retrieve</span><span class="token punctuation">(</span><span class="token class-name">BarbelQueries</span><span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token string">"someId"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>The data of the required document IDs will be lazy loaded into <code>BarbelHisto</code>.</p>
<blockquote>
<p>For a complete integration register the update handler methods as well as the lazy loading handlers. Note that lazy loading always requires to register the listeners to the <strong>&gt;synchronous&lt;</strong> event bus.</p>
</blockquote>
<h3><a class="anchor" aria-hidden="true" id="error-handling-with-synchronous-events"></a><a href="#error-handling-with-synchronous-events" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Error handling with synchronous events</h3>
<p>With synchronous event listeners clients can implement error handling in case of any errors in the event handlers. By default event listeners fail silently. This is because subsequent handlers should not be harmed when one handler fails. However, you can change that behavior for <strong>synchronous</strong> listeners by calling the <code>HistoEvent.failed()</code>. This will produce a <code>HistoEventFailedException</code> when the control returns to <code>BarbelHisto</code>.</p>
<pre><code class="hljs css language-java"><span class="token annotation punctuation">@Subscribe</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleInserts</span><span class="token punctuation">(</span><span class="token class-name">InsertBitemporalEvent</span> event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// some processing logic that might fail</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        event<span class="token punctuation">.</span><span class="token function">failed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>When the event was set to failed <code>BarbelHisto</code> clients can handle the <code>HistoEventException</code>thrown. It's also possible to pass back context data from within the listener method back to the clients exception handling.</p>
<pre><code class="hljs css language-java"><span class="token annotation punctuation">@Subscribe</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleInserts</span><span class="token punctuation">(</span><span class="token class-name">InsertBitemporalEvent</span> event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// some processing logic that might fail</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        event<span class="token punctuation">.</span><span class="token function">getEventContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"errorContext"</span><span class="token punctuation">,</span> <span class="token string">"some error handling information"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        event<span class="token punctuation">.</span><span class="token function">failed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>To get the context information clients just need to catch the <code>HistoEventFailedException</code>:</p>
<pre><code class="hljs css language-java"><span class="token keyword">try</span> <span class="token punctuation">{</span>
    core<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>pojo<span class="token punctuation">,</span> <span class="token class-name">LocalDate</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">plusDays</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">LocalDate</span><span class="token punctuation">.</span>MAX<span class="token punctuation">)</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">HistoEventFailedException</span> exception<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> contextData <span class="token operator">=</span> exception<span class="token punctuation">.</span><span class="token function">getEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getEventContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"errorContext"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// do some recovery actions based on context data</span>
<span class="token punctuation">}</span>
</code></pre>
<h2><a class="anchor" aria-hidden="true" id="custom-persistence"></a><a href="#custom-persistence" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Custom persistence</h2>
<p>When you want to use other custom persistence alternatives as the ones we've described previously then <code>BarbelHisto</code> can export the backbone version data of a given document ID by calling the <code>BarbelHisto.unload()</code> and <code>BarbelHisto.load()</code> methods. Let's say you've created the data with <code>BarbelHisto</code>, then you export the data like so:</p>
<pre><code class="hljs css language-java"><span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Bitemporal</span><span class="token punctuation">></span></span> unload <span class="token operator">=</span> core<span class="token punctuation">.</span><span class="token function">unload</span><span class="token punctuation">(</span><span class="token string">"somePersonelNumber"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>Notice that an unload removes that versions from the backbone collection. You can now store the complete version data for that given document ID to a data store of your choice. Later you can call <code>BarbelHisto.load()</code> to restore the <code>BarbelHisto</code> instance state for the document ID. If the version data of a given document ID is restored, clients can continue to post updates for that document ID.</p>
<pre><code class="hljs css language-java"><span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Bitemporal</span><span class="token punctuation">></span></span> versionData <span class="token operator">=</span> <span class="token comment">// ... some custom persistence service here that draws </span>
                                     <span class="token comment">//     the version data for 'somePersonelNumber' from the data store!</span>
core<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>versionData<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>The <code>BarbelHisto</code> instance must not contain any of the version data for the document IDs you try to load, otherwise you receive errors. This was made to ensure consistency of the version data.</p>
</span></div></article></div><div class="docs-prevnext"><a class="docs-prev button" href="/docs/1.7.0/events"><span class="arrow-prev">← </span><span>Using events</span></a><a class="docs-next button" href="/docs/1.7.0/diskpersistence"><span>Disk persistence</span><span class="arrow-next"> →</span></a></div></div></div><nav class="onPageNav"><ul class="toc-headings"><li><a href="#cqengine-built-in-persistence">CqEngine built-in persistence</a></li><li><a href="#event-based-persistence">Event-based persistence</a><ul class="toc-headings"><li><a href="#shadow-data-source">Shadow data source</a></li><li><a href="#lazy-loading-external-data">Lazy loading external data</a></li><li><a href="#error-handling-with-synchronous-events">Error handling with synchronous events</a></li></ul></li><li><a href="#custom-persistence">Custom persistence</a></li></ul></nav></div><footer class="nav-footer" id="footer"><section class="sitemap"><a href="/" class="nav-home"><img src="/img/small_barbel.png" alt="BarbelHisto" width="66" height="58"/></a><div><h5>Docs</h5><a href="/docs/getstarted.html">Getting Started</a></div><div><h5>Community</h5><a href="https://github.com/projectbarbel/barbelhisto-core/issues">Report issue</a></div><div><h5>More</h5><a href="https://github.com/projectbarbel/barbelhisto-core">GitHub</a><a class="github-button" href="https://github.com/projectbarbel/barbelhisto-core" data-icon="octicon-star" data-count-href="/stargazers" data-show-count="true" data-count-aria-label="# stargazers on GitHub" aria-label="BarbelHisto">Star</a></div></section><section class="copyright">Copyright © 2022 Project Barbel</section></footer></div></body></html>